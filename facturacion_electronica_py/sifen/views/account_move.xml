<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- account.move inherit form view -->
        <record id="view_move_form" model="ir.ui.view">
            <field name="name">view_move_form</field>
            <field name="model">account.move</field>
            <field name="inherit_id" ref="account.view_move_form" />
            <field name="arch" type="xml">

                <!-- Agregamos el boton de anular factura para facturas de proveedor (autofactura) -->
                <xpath expr="//button[@name='button_anular']" position="replace">
                    <button string="Anular factura" type="object" name="button_anular"
                        attrs="{'invisible':['|','|',('id','=',False),('state','=','cancel'),('move_type','not in',['out_invoice','out_refund', 'in_invoice'])]}" />
                </xpath>

                <!-- Datos relacionados a SIFEN -->
                <xpath expr="//notebook" position="inside">
                    <page string="SIFEN" groups="sifen.datos_sifen">

                        <group string="Información sobre el estado en la SET">
                            <field name="fe_valida" string="Documento Electrónico Válido" readonly="1" />
                            <field name="estado_set" string="Estado SET" widget="badge" decoration-warning="estado_set == 'preparado'" decoration-info="estado_set in ['ingresado', 'lote_reenviando']" decoration-success="estado_set == 'aprobado'" decoration-danger="estado_set in ['rechazado', 'inutilizado', 'cancelado', 'error_sifen', 'lote_rechazado']" readonly="1" />
                            <field name="cdc" readonly="1" />
                            <field name="xml_file_name" invisible="1" />
                            <field name="xml_file" filename="xml_file_name" readonly="1" string="Documento XML" />
                            <field name="nro_transaccion_set" readonly="1" string="Nro. Trasacción SET" />
                            <field name="mensaje_set" readonly="1" />
                            <field name="mensaje_set_detalle" readonly="1" />
                            <field name="estado_anulacion" readonly="1" />
                            <field name="motivo_cancelacion" readonly="1" attrs="{'invisible': [('estado_set', '!=', 'cancelado')]}"/>
                            <field name="mensaje_anulacion" readonly="1" />
                            <field name="invoice_datetime" readonly="1" widget="datetime" string="Fecha de emisión" />
                            <field name="fecha_hora_firma" readonly="1" widget="datetime" string="Fecha de firma"/>
                            <field name="fecha_procesamiento_set" readonly="1" widget="datetime" string="Fecha de procesamiento SIFEN"/>
                            <field name="lote_id" readonly="1" string="Nro Lote" />
                            <field name="dcarQR" widget="url" readonly="1" string="QR Link" />
                            <field name="validacion_esquema" readonly="1" string="Schema xsd" attrs="{'invisible': [('validacion_esquema', '=', None)]}" />
                            <field name="error_generacion" readonly="1" string="Error XML" attrs="{'invisible': [('error_generacion', '=', None)]}" />
                            <field name="tipo_documento" readonly="1" />
                            <field name="documento_enviado_mail" readonly="1" string="Mail enviado" />
                        </group>

                        <group string="Acciones disponibles para este documento">
                            <div>
                                <button string="Generar Documento XML" name="preparar_documento_electronico" type="object" class="oe_highlight mr-4 rounded" attrs="{'invisible': [('estado_set', 'not in', ['pendiente', 'error_sifen','lote_rechazado','lote_reenviando','rechazado', 'borrador'])]}" />
                                <button string="Preparar todos los Lotes" name="preparar_lote" type="object" class="oe_highlight mr-4 rounded" attrs="{'invisible': [('estado_set', '!=', 'pendiente')]}" />
                                <button string="Enviar todos los Lotes" name="enviar_lote" type="object" class="oe_highlight mr-4 rounded" attrs="{'invisible': [('estado_set', '!=', 'preparado')]}" />
                                <button string="Consultar todos los Lotes" name="consultar_lote" type="object" class="oe_highlight mr-4 rounded" attrs="{'invisible': [('estado_set', 'not in', ['ingresado', 'error_sifen', 'lote_reenviando'])]}" />
                                <button string="Consultar por CDC" name="consultar_cdc_documento_electronico" type="object" class="oe_highlight mr-4 rounded" attrs="{'invisible': [('estado_set', 'not in', ['ingresado', 'error_sifen', 'lote_reenviando'])]}" />
                                <button string="Inutilizar Documento" name="button_inutilizar_factura" type="object" class="oe_highlight mr-4 rounded btn-danger" attrs="{'invisible': [('estado_set', 'not in', ['rechazado'])]}" />
                            </div>
                        </group>

                        <group string="Request realizados para el Documento Electrónico" groups="sifen.logs_requests">
                            <field name="sifen_requests" widget="one2many_list" readonly="1">
                                <tree>
                                    <field name="name" />
                                    <field name="accion" />
                                    <field name="status_code" />
                                    <field name="write_date" string="Fecha/Hora" />
                                </tree>
                            </field>
                        </group>

                    </page>
                </xpath>
                <xpath expr="//group[@name='accounting_info_group']/field[@name='to_check']" position="after">
                    <field name="doc_asociado" readonly="True" attrs="{'invisible':[('move_type','!=','out_refund')]}"/>
                </xpath>

                <!-- Campos para compras publicas -->
                <xpath expr="//notebook" position="inside">
                    <field name="tipo_operacion" invisible="1" />
                    <page string="DNCP" attrs="{'invisible':[('tipo_operacion','!=','3')]}">

                        <group string="Campos de informaciones de Compras Públicas">
                            <field name="dncp_cod_modalidad" attrs="{'readonly': [('state', 'not in', ['draft', 'cancel'])]}" />
                            <field name="dncp_cod_entidad" attrs="{'readonly': [('state', 'not in', ['draft', 'cancel'])]}" />
                            <field name="dncp_cod_anho" attrs="{'readonly': [('state', 'not in', ['draft', 'cancel'])]}" />
                            <field name="dncp_cod_sec" attrs="{'readonly': [('state', 'not in', ['draft', 'cancel'])]}" />
                            <field name="dncp_fecha_emision" attrs="{'readonly': [('state', 'not in', ['draft', 'cancel'])]}" />
                        </group>

                    </page>
                </xpath>
            </field>
        </record>

        <!-- account.move search view -->
        <!-- account.move inherit search view -->
        <record id="view_account_invoice_filter" model="ir.ui.view">
            <field name="name">view_account_invoice_filter</field>
            <field name="model">account.move</field>
            <field name="inherit_id" ref="account.view_account_invoice_filter" />
            <field name="arch" type="xml">
                <xpath expr="//search" position="inside">
                    <separator />
                    <filter name="filter_borrador" string="DE Borrador" domain="[('estado_set','=','borrador')]" />
                    <filter name="filter_aprobado" string="DE Pendiente" domain="[('estado_set','=','pendiente')]" />
                    <filter name="filter_aprobado" string="DE Asociado" domain="[('estado_set','=','preparado')]" />
                    <filter name="filter_aprobado" string="DE Aprobado" domain="[('estado_set','=','aprobado')]" />
                    <filter name="filter_rechazado" string="DE Rechazado" domain="[('estado_set','=','rechazado')]" />
                    <filter name="filter_cancelado" string="DE Cancelado" domain="[('estado_set','=','cancelado')]" />
                    <filter name="filter_inutilizado" string="DE Inutilizado" domain="[('estado_set','=','inutilizado')]" />
                    <separator />
                    <filter name="filter_ingresado" string="Lote ingresado" domain="[('estado_set','=','ingresado')]" />
                    <filter name="filter_lote_rechazado" string="Lote rechazado" domain="[('estado_set','=','lote_rechazado')]" />
                    <filter name="filter_reenviando" string="Lote intento de reenvío" domain="[('estado_set','=','lote_reenviando')]" />
                    <filter name="filter_error" string="Error SIFEN" domain="[('estado_set','=','error_sifen')]" />
                    <filter name="groupby_estado_set" string="Estado SET" context="{'group_by': 'estado_set'}" />
                </xpath>

            </field>
        </record>

        <!-- Menu para Notas de Débito -->
        <record id="sifen.notas_debito" model="ir.actions.act_window">
            <field name="name">Notas de débito</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">account.move</field>
            <field name="view_mode">tree,form,pivot</field>
            <field name="context">{'default_move_type': 'out_invoice', 'default_tipo_documento': 'nota_debito'}</field>
        </record>
        <menuitem id="menu_sifen_nota_debito" name="Notas de débito" parent="account.menu_finance_receivables" action="sifen.notas_debito" sequence="2" />

        <!-- Menu para Notas de Crédito -->
        <record id="account.action_move_out_refund_type" model="ir.actions.act_window">
            <field name="context">{'default_move_type': 'out_refund', 'default_tipo_documento': 'out_refund'}</field>
        </record>

        <!-- Menu para Factura -->
        <record id="account.action_move_out_invoice_type" model="ir.actions.act_window">
            <field name="context">{'default_move_type': 'out_invoice', 'default_tipo_documento': 'out_invoice'}</field>
        </record>

        <!-- Menu para Autofactura -->
        <record id="account.action_move_in_invoice_type" model="ir.actions.act_window">
            <field name="context">{'default_move_type': 'in_invoice', 'default_tipo_documento': 'autofactura'}</field>
        </record>

        <!-- Acciones de servidor -->
        <record id="sifen.regenerar_facturas_xml" model="ir.actions.server">
            <field name="name">Regenerar XML</field>
            <field name="binding_model_id" ref="account.model_account_move" />
            <field name="model_id" ref="account.model_account_move" />
            <field name="state">code</field>
            <field name="code">records.accion_servidor_regenerar_xml()</field>
        </record>
        <record id="sifen.consultar_cdc" model="ir.actions.server">
            <field name="name">Consultar CDC Individual</field>
            <field name="binding_model_id" ref="account.model_account_move" />
            <field name="model_id" ref="account.model_account_move" />
            <field name="state">code</field>
            <field name="code">records.consultar_cdc_documento_electronico()</field>
        </record>

    </data>
</odoo>