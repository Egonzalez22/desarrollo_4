<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <data>

        <record id="cuotas.cuota_form_view" model="ir.ui.view">
            <field name="name">cuota_form_view</field>
            <field name="model">cuotas.cuota</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <field name="invoice_ids" invisible="True"/>
                        <field name="totalmente_facturado" invisible="True"/>
                        <button string="Facturar" type="object" name="button_facturar" class="oe_highlight"
                                attrs="{'invisible':['|','|',('totalmente_facturado','=',True),('state','!=','confirmado')]}"/>
                        <!-- <button string="Marcar como pagado" type="object" name="action_marcar_pagado" attrs="{'invisible':[('state','in',['cancel','pagado'])]}"/> -->
                        <button string="Confirmar" type="object" name="button_confirmar" attrs="{'invisible':[('state','!=','draft')]}" class="oe_highlight"/>
                        <button string="Cambiar a borrador" type="object" name="button_borrador" attrs="{'invisible':[('state','!=','cancel')]}"/>
                        <button string="Cancelar" type="object" name="action_cancelar" attrs="{'invisible':[('payment_state','!=','not_paid')]}"/>
                        <field name="vencida" invisible="True"/>
                        <field name="state" widget="statusbar"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">

                            <button name="action_view_invoice" type="object" class="oe_stat_button" icon="fa-pencil-square-o"
                                    attrs="{'invisible': [('invoice_count', '=', 0)]}">
                                <field name="invoice_count" widget="statinfo" string="Facturas"/>
                            </button>

                        </div>
                        <h3 class="oe_title">
                            <field name="name"/>
                        </h3>

                        <group>
                            <group>
                                <field name="tipo_cuota"/>
                                <field name="nro_cuota"/>
                                <field name="partner_id" attrs="{'readonly':[('state','!=','draft')]}"/>

                                <field name="phone" attrs="{'readonly':[('state','!=','draft')]}"/>
                                <field name="product_id" attrs="{'readonly':[('state','!=','draft')]}"/>
                                <field name="analytic_account_id" attrs="{'readonly':[('state','!=','draft')]}"/>
                                <field name="payment_state" readonly="True"/>
                            </group>
                            <group>
                                <field name="currency_id" attrs="{'readonly':[('state','!=','draft')]}"/>
                                <field name="monto_cuota" attrs="{'readonly':[('state','!=','draft')]}"/>
                                <field name="descuento_porcentaje" attrs="{'readonly':[('state','!=','draft')]}"/>
                                <field name="monto_neto_cuota" attrs="{'readonly':[('state','!=','draft')]}"/>
                                <field name="monto_facturado" string="Monto facturado"/>
                                <field name="monto_a_facturar" string="Saldo a facturar"/>
                                <field name="saldo_pagar" string="Saldo a pagar"/>
                                <field name="totalmente_facturado_aux" invisible="True"/>
                                <field name="descuento_monto" invisible="True"/>
                                <field name="fecha_facturacion" attrs="{'required':[('tipo_cuota','=','sale')]}"/>
                                <field name="fecha_vencimiento"/>
                                <field name="fecha_pago"/>
                            </group>
                        </group>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="message_ids" widget="mail_thread"/>
                        <field name="activity_ids" widget="mail_activity"/>
                    </div>
                </form>
            </field>
        </record>
        <record id="cuotas.cuota_tree_view" model="ir.ui.view">
            <field name="name">cuota_tree_view</field>
            <field name="model">cuotas.cuota</field>
            <field name="arch" type="xml">
                <tree decoration-danger="vencida==True" decoration-warning="state=='draft'" decoration-muted="state=='cancel'"
                      decoration-success="payment_state=='paid'" multi_edit="True">
                    <header>
                        <button string="Generar cuotas" type="object" name="button_generar_cuotas"/>
                        <button string="Confirmar" type="object" name="button_confirmar" attrs="{'invisible':[('state','!=','draft')]}" class="oe_highlight"/>
                        <button string="Cambiar a borrador" type="object" name="button_borrador" attrs="{'invisible':[('state','!=','cancel')]}"/>
                    </header>
                    <field name="tipo_cuota" optional="show"/>
                    <field name="name" optional="hide"/>
                    <field name="partner_id"/>
                    <field name="product_id" optional="hide"/>
                    <field name="analytic_account_id" optional="hide"/>
                    <field name="monto_cuota" sum="Total"/>
                    <field name="monto_facturado" string="Monto facturado" sum="Total"  optional="show"/>
                    <field name="monto_a_facturar" string="Saldo a facturar" sum="A facturar" optional="show"/>
                    <field name="saldo_pagar" string="Saldo a pagar" sum="A pagar" optional="show"/>
                    <field name="saldo_pagar_company_currency" sum="A pagar" optional="hide"/>
                    <field name="descuento_porcentaje"  optional="hide"/>
                    <field name="descuento_monto" invisible="True"/>
                    <field name="fecha_facturacion"/>
                    <field name="fecha_vencimiento"  optional="hide"/>
                    <field name="fecha_pago" optional="hide"/>
                    <field name="nro_cuota" optional="hide"/>
                    <field name="state" readonly="True"/>
                    <field name="payment_state" readonly="True"/>
                    <field name="vencida" invisible="True"/>
                    <field name="meta_id" optional="hide"/>
                </tree>
            </field>
        </record>
        <!-- model.name search view -->
        <record id="cuotas.cuota_search_view" model="ir.ui.view">
            <field name="name">Cuota search</field>
            <field name="model">cuotas.cuota</field>
            <field name="arch" type="xml">
                <search string="Busqueda">
                    <field name="partner_id" string="Empresa" filter_domain="['|',('partner_id.name','ilike',self),('partner_id.vat','ilike',self)]"/>
                    <field name="product_id" string="Producto"/>
                    <field name="analytic_account_id" string="Cuenta analitica"/>
                    <filter name="filter_ingresos" string="Ingreso" domain="[('tipo_cuota','=','sale')]"/>
                    <filter name="filter_egresos" string="Egreso" domain="[('tipo_cuota','=','purchase')]"/>
                    <separator/>
                    <filter name="filter_vencida" string="Vencida"
                            domain="[('fecha_vencimiento','&lt;',current_date),('state','=','confirmado'),'|',('payment_state','=',False),('payment_state','=','not_paid')]"/>
                    <filter name="filter_pendiente" string="Pendiente"
                            domain="[('state','=','confirmado'),'|',('payment_state','=','not_paid'),(('payment_state','=',False))]"/>
                    <filter name="filter_pagado" string="Pagado" domain="[('payment_state','=','paid')]"/>
                    <filter name="filter_confirmado" string="Confirmado" domain="[('state','=','confirmado')]"/>
                    <filter name="filter_borrador" string="Borrador" domain="[('state','=','draft')]"/>
                    <filter name="filter_cancelado" string="Cancelado" domain="[('state','=','cancel')]"/>
                    <separator/>
                    <filter name="filter_facturado" string="Totalmente facturado" domain="[('totalmente_facturado','=',True)]"/>
                    <filter name="filter_facturar" string="A facturar" domain="[('monto_a_facturar','>',0),('state','=','confirmado')]"/>
                    <separator/>
                    <filter name="filter_fecha_vencimiento" date="fecha_vencimiento" string="Fecha de vencimiento" default_period="this_month"/>
                    <filter name="groupby_tipo_cuota" string="Tipo de cuota" context="{'group_by': 'tipo_cuota'}"/>
                    <filter name="groupby_partner" string="Empresa" context="{'group_by': 'partner_id'}"/>
                    <filter name="groupby_product" string="Producto" context="{'group_by': 'product_id'}"/>
                    <filter name="groupby_analytic_account" string="Cuenta Analitica" context="{'group_by': 'analytic_account_id'}"/>
                    <filter name="groupby_payment_state" string="Estado de pago" context="{'group_by': 'payment_state'}"/>
                    <filter name="groupby_state" string="Estado" context="{'group_by': 'state'}"/>
                    <filter name="groupby_fecha_vencimiento" string="Fecha de vencimiento" context="{'group_by': 'fecha_vencimiento:month'}"/>
                </search>
            </field>
        </record>
        <!-- model.name pivot view -->
        <record id="cuotas.cuotas_pivot_view" model="ir.ui.view">
            <field name="name">Pivot de Cuotas</field>
            <field name="model">cuotas.cuota</field>
            <field name="arch" type="xml">
                <pivot string="Pivot de cuotas" display_quantity="False">
                    <field name="amount_signed" type="measure"/>
                    <field name="tipo_cuota" type="row"/>
                    <field name="partner_id" type="row"/>
                    <field name="fecha_vencimiento" type="col"/>

                </pivot>
            </field>
        </record>
        <record model="ir.actions.server" id="cuotas.action_server_cancelar">
            <field name="name">Cancelar cuotas</field>
            <field name="binding_model_id" ref="cuotas.model_cuotas_cuota"/>
            <field name="model_id" ref="cuotas.model_cuotas_cuota"/>
            <field name="state">code</field>
            <field name="code">
                records.action_cancelar()
            </field>
        </record>
        <record model="ir.actions.server" id="cuotas.action_server_cancelar">
            <field name="name">Confirmar cuotas</field>
            <field name="binding_model_id" ref="cuotas.model_cuotas_cuota"/>
            <field name="model_id" ref="cuotas.model_cuotas_cuota"/>
            <field name="state">code</field>
            <field name="code">
                records.button_confirmar()
            </field>
        </record>
        <!--  <record model="ir.actions.server" id="cuotas.action_server_pagar">
            <field name="name">Marcar como pagado</field>
            <field name="binding_model_id" ref="cuotas.model_cuotas_cuota"/>
            <field name="model_id" ref="cuotas.model_cuotas_cuota"/>
            <field name="state">code</field>
            <field name="code">
        records.action_marcar_pagado()
            </field> 
        </record>-->
        <record model="ir.actions.server" id="cuotas.action_server_facturar">
            <field name="name">Facturar</field>
            <field name="binding_model_id" ref="cuotas.model_cuotas_cuota"/>
            <field name="model_id" ref="cuotas.model_cuotas_cuota"/>
            <field name="state">code</field>
            <field name="code">action=records.button_facturar()
            </field>
        </record>


        <record id="cuotas.cuotas_action_window" model="ir.actions.act_window">
            <field name="name">Cuotas</field>
            <field name="res_model">cuotas.cuota</field>
            <field name="view_mode">tree,form,pivot,graph,activity</field>
            <field name="context">{"search_default_filter_confirmado":1}</field>
        </record>
        <!-- This Menu Item must have a parent and an action -->
        <menuitem id="menu_cuotas" name="Cuotas" action="cuotas.cuotas_action_window" parent="account.menu_finance_entries" sequence="90"/>

    </data>


</odoo>
